#!/usr/bin/env bash

[[ -n "${DEBUG}" ]] && set -x
set -eo pipefail

KCNF_DIR="${KCNF_DIR:-${HOME}/.kube/configs}"
KCNF_HEIGHT="${KCNF_HEIGHT:-40%}"

DEPENDENCIES=(fzf bat)

### show help message and exit
# arg: none
show_help() {
  cat << EOF | bat --style=plain --language=man
kubectl cnf helps switch between current-contexts in multiple kubeconfigs

Usage:
  kubectl cnf [-h] [<string>]

Flags:
  -h, --help    show this message

Dependencies:
  fzf - https://github.com/junegunn/fzf
  bat - https://github.com/sharkdp/bat

  xsel (Linux x11 clipboard) - https://github.com/kfish/xsel
  wl-copy (Linux Wayland clipboard) - https://github.com/bugaevc/wl-clipboard
  pbcopy (Darwin clipboard)

Prerequisites:
  directory '${KCNF_DIR}' populated with kubeconfig files
EOF
  exit 0
}

### ensure that dependencies are installed
# arg: none
check_requirements() {
  local dep

  for dep in "${DEPENDENCIES[@]}"; do
    hash "${dep}" 2>/dev/null || err "missing core dependency: ${dep}"
  done
}

### show error message and exit
# arg: $1 - text
err() {
  echo "ðŸ®² error: $1" >&2
  exit 1
}

copy_to_clipboard() {
  local platform clipboard_bin clipboard_arg

  platform=$(uname)
  case "${platform}" in
    Linux)  case "${XDG_SESSION_TYPE:-x11}" in
              x11)     clipboard_bin="xsel"; clipboard_arg="--clipboard --trim"              ;;
              wayland) clipboard_bin="wl-copy"; clipboard_arg="--trim-newline"               ;;
              *)       err "clipboard copy is not supported on session: ${XDG_SESSION_TYPE}" ;;
            esac
            ;;
    Darwin) clipboard_bin="pbcopy"
            ;;
    *)      err "clipboard copy is not supported on platform: ${platform}"
            ;;
  esac

  hash "${clipboard_bin}" 2>/dev/null || err "missing clipboard dependency: ${clipboard_bin}"
  echo "export KUBECONFIG='${KUBECONFIG}'" | "${clipboard_bin}" ${clipboard_arg}
}

main() {
  local kubeconfigs selected_kubeconfig

  check_requirements
  [[ " $@ " =~ ( -h | --help ) ]] && show_help

  [[ -d "${KCNF_DIR}" ]] || err "directory does not exist: ${KCNF_DIR}"
  kubeconfigs=$(find "${KCNF_DIR}" \( -type f -o -type l \) -exec awk '/^current-context:/ {print FILENAME, $2}' {} +)
  [[ -n "${kubeconfigs}" ]] || err "no valid kubeconfigs found in directory: ${KCNF_DIR}"

  selected_kubeconfig=$(sort --key=2 <<< "${kubeconfigs}" | fzf \
    --height="${KCNF_HEIGHT}" \
    --layout=reverse \
    --with-nth=2 \
    --query="${*:-}" \
    --bind="tab:toggle-preview" \
    --preview="bat --style=header --color=always --language=yaml {1}" \
    --preview-window="hidden,wrap,75%")

  export KUBECONFIG="${selected_kubeconfig%% *}"
  export KUBECONTEXT="${selected_kubeconfig##* }"

  if [[ -n "${KCNF_NO_SHELL}" ]]; then
    [[ -n "${KCNF_NO_VERBOSE}" ]] || echo "â®º ${KUBECONTEXT}"
    if [[ -n "${KCNF_COPY_CLIP}" ]]; then
      copy_to_clipboard
    else
      echo "export KUBECONFIG='${KUBECONFIG}'"
    fi
  else
    [[ -n "${KCNF_NO_VERBOSE}" ]] || echo "â‡² ${KUBECONTEXT}"
    "${SHELL}"
    [[ -n "${KCNF_NO_VERBOSE}" ]] || echo "â‡± ${KUBECONTEXT}"
  fi
  exit 0
}

main "$@"
